@page "/facilities"
@using SoVet.BlazorWebClient.Shared.Windows
@attribute [Authorize(Roles = Role.Administrator)]
@inject IFacilityService FacilityService;
@inject ISnackbar Snackbar;
@inject IDialogService DialogService;

<PageTitle>Услуги</PageTitle>
<MudDataGrid @ref="_dataGrid" Striped="true" T="Facility" Items="_facilities" Filterable="true">
    <Columns>
        <PropertyColumn Property="x => x.Name" Title="Наименование"/>
        <PropertyColumn Property="x => x.Cost" Title="Стоимость"/>
        <PropertyColumn Property="x => x.FacilityCategory.Name" Title="Категория" Filterable="false"/>
        <TemplateColumn Filterable="false">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.MoreHoriz" Color="Color.Secondary" Variant="Variant.Filled"
                               OnClick="@(async() => await OpenEditWindow(context.Item))"/>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>
<MudFab Style="position: fixed; bottom: 0; right: 0; margin: 35px 25px;" Color="Color.Secondary" Icon="@Icons.Material.Filled.Add" OnClick="@(async () => await OpenEditWindow(new Facility()))"></MudFab>
@code {
    private List<Facility>? _facilities = null!;
    private MudDataGrid<Facility> _dataGrid = null!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var facilities = await FacilityService.GetFacilities();

        _facilities = facilities;
        if (facilities is null)
        {
            _facilities = new();
        }
    }

    private async Task OpenEditWindow(Facility? facility)
    {
        var options = new DialogOptions
        {
            Position = DialogPosition.Center, CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true
        };

        var parameters = new DialogParameters
        {
            { "Model", facility }
        };

        var dialog = await DialogService.ShowAsync<FacilityWindow>("Услуга", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            Snackbar.Add("Успешно", Severity.Success);
        }
    }
}