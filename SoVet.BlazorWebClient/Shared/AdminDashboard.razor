@using SoVet.BlazorWebClient.Extensions
@using Radzen.Blazor
@using SoVet.BlazorWebClient.Shared.Windows
@using DialogOptions = MudBlazor.DialogOptions
@using DialogPosition = MudBlazor.DialogPosition
@using Radzen
@using Variant = MudBlazor.Variant
@using System.Globalization

@inject IRegistrationService RegistrationService;
@inject IDialogService DialogService;
@inject NavigationManager NavigationManager;
@inject AuthenticationStateProvider AuthenticationStateProvider;

<MudText>

</MudText>
<MudGrid Style="min-height: 90vh">
    <MudItem xs="12" lg="8" md="8">
        <MudGrid>
            <MudItem xs="12" md="12" lg="12">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h4">120</MudText>
                        <MudText Typo="Typo.h6">Приемов в этом месяце</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem lg="8" md="8" xs="12">
                <MudCard>
                    <MudCardHeader >
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6" Class="mr-3">Всего приемов</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudDatePicker Variant="Variant.Outlined" Style="width: 200px; height: 50px;" OpenTo="OpenTo.Year"
                                           FixMonth="@DateTime.Today.Month" DisableToolbar="true"
                                           @bind-Date="Year" FixDay="@DateTime.Today.Day" DateFormat="yyyy"/>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <RadzenChart Style="min-height: 65vh">
                            <RadzenLineSeries Data="@_facilitiesIncome" CategoryProperty="Category" ValueProperty="Count"
                                              Title="@(DateTime.Today.Year.ToString())" LineType="LineType.Solid"> 
                                <RadzenMarkers MarkerType="MarkerType.Circle"/>
                                <RadzenSeriesDataLabels Visible="false"/>
                                <RadzenLegend Visible="false"/>
                                <RadzenCategoryAxis/>
                            </RadzenLineSeries>
                            <RadzenValueAxis>
                                <RadzenGridLines Visible="true"/>
                            </RadzenValueAxis>
                        </RadzenChart>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem lg="4" md="4" xs="12">
                <MudCard>
                    <MudCardHeader Class="text-center">
                        <MudText Typo="Typo.h6" Class="text-center">Приемы cегодня</MudText>
                    </MudCardHeader>
                    <MudCardContent>
                        <RadzenChart>
                            <RadzenChart Style="min-height: 37.7vh">
                                <RadzenLegend Position="LegendPosition.Bottom"></RadzenLegend>
                                <RadzenDonutSeries Data="@_appointmentsStatusesInfo" CategoryProperty="Category" ValueProperty="Count" TotalAngle="180" StartAngle="180">
                                    <TooltipTemplate Context="data">
                                        @data.Category
                                        @data.Count
                                    </TooltipTemplate>
                                    <ChildContent>
                                        <RadzenSeriesDataLabels Visible="true"/>
                                    </ChildContent>
                                </RadzenDonutSeries>
                            </RadzenChart>
                        </RadzenChart>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudItem>
    <MudItem xs="12" md="4" lg="4">
        <MudCard>
            <MudCardContent>
                <RadzenScheduler @ref=@_scheduler TItem="Registration" Data=@_registrations StartProperty="StartTime" EndProperty="StartTime"
                                 TextProperty="ScheduleText" SelectedIndex="0" TodayText="Сегодня" AppointmentSelect="RegistrationSelect" Style="height: 87.7vh"
                                 AppointmentRender="@OnAppointmentRender">
                    <RadzenDayView StartTime="@StartTime" EndTime="@EndTime" TimeFormat="H:mm" Text="День"/>
                </RadzenScheduler>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>


@code {
    private DateTime? Year { get; set; } = DateTime.Today;

    class DataItem
    {
        public string Category { get; set; }
        public double Count { get; set; }
    }

    DataItem[] _appointmentsStatusesInfo =
    {
        new()
        {
            Category = AppointmentStatus.Active.GetDisplayName()!,
            Count = 4
        },
        new()
        {
            Category = AppointmentStatus.Finished.GetDisplayName()!,
            Count = 6
        },
        new()
        {
            Category = AppointmentStatus.NotVisited.GetDisplayName()!,
            Count = 2
        },
        new()
        {
            Category = AppointmentStatus.WaitingStart.GetDisplayName()!,
            Count = 1
        }
    };

    DataItem[] _appointmentsPickInfo =
    {
        new()
        {
            Category = DateTime.Today.ToString("d"),
            Count = 2
        }
    };

    DataItem[] _facilitiesIncome =
    {
        new() { Category = "Янв.", Count = 1 },
        new() { Category = "Фев.", Count = 2 },
        new() { Category = "Мар.", Count = 3 },
        new() { Category = "Апр.", Count = 75 },
        new() { Category = "Май", Count = 60 },
        new() { Category = "Июнь", Count = 6 },
        new() { Category = "Июль", Count = 3 },
        new() { Category = "Авг.", Count = 50 },
        new() { Category = "Сен.", Count = 5 },
        new() { Category = "Окт.", Count = 5 },
        new() { Category = "Нояб.", Count = 5 },
        new() { Category = "Дек.", Count = 35 }
    };

    RadzenScheduler<Registration> _scheduler = null!;
    private List<Registration>? _registrations = new();

    public static TimeSpan StartTime = new(8, 0, 0);
    public static TimeSpan EndTime = new(23, 0, 0);


    protected override async Task OnInitializedAsync()
    {
        var userIdentity = (await AuthenticationStateProvider.GetAuthenticationStateAsync()).User;
        var employeeId = int.Parse(userIdentity.Claims.First(x => x.Type == UserClaims.EmployeeId).Value);

        _registrations = userIdentity.IsInRole(Role.Administrator)
            ? await RegistrationService.GetRegistrations(null)
            : await RegistrationService.GetRegistrations(employeeId);

        await base.OnInitializedAsync();
    }

    private async Task RegistrationSelect(SchedulerAppointmentSelectEventArgs<Registration> args)
    {
        var options = new DialogOptions
        {
            Position = DialogPosition.Center, CloseButton = true, MaxWidth = MaxWidth.Large, FullWidth = true
        };

        var parameters = new DialogParameters
        {
            { "Model", args.Data }
        };

        var dialog = await DialogService.ShowAsync<CreateAppointmentWindow>("Прием", parameters, options);
        var result = await dialog.Result;
    }

    private void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<Registration> args)
    {
        args.Attributes["style"] = "background: #3F51B5";
    }

}