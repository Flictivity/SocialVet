@using SoVet.BlazorWebClient.Extensions
@inject IDialogService DialogService;
@inject IAppointmentService AppointmentService;

@if (_model is null)
{
    <MudAlert Severity="Severity.Info" Class="mt-3">Не удалось загрузить информацию о приеме...</MudAlert>
    return;
}

<MudCard Class="pa-4">
    <MudTabs Rounded="true">
        <MudTabPanel Text="Лист осмотра" Icon="@Icons.Material.Filled.ViewList">
            <MudSelect T="AppointmentStatus" Label="Статус" Variant="Variant.Outlined" Class="pa-0 mt-3">
                @foreach (AppointmentStatus status in Enum.GetValues(typeof(AppointmentStatus)))
                {
                    <MudSelectItem Value="@status">
                        <MudChip Class="ma-0" Style="@($"color:#FFFFFF; background:{StatusColors.StatusColor[status]};")">
                            @status.GetDisplayName()
                        </MudChip>
                    </MudSelectItem>
                }
            </MudSelect>
            <MudCard Elevation="2" Class="mt-3 mb-3">
                <MudCardContent>
                    <MudStack Row="true" Class="mb-3">
                        <MudTextField T="string" Label="Цель визита" Variant="Variant.Outlined" @bind-Value="_model.Purpose"/>
                        <MudTextField ReadOnly="true" T="string" Label="Ветеринар" Variant="Variant.Outlined" Value="@_model.Employee.Name"/>
                    </MudStack>
                    <MudTextField T="string" Label="Анамнез" Lines="3" FullWidth="true" Variant="Variant.Outlined" @bind-Value="_model.Anamnesis" Class="mb-3"/>
                    <MudTextField T="string" Label="Осмотр" Lines="3" FullWidth="true" Variant="Variant.Outlined" @bind-Value="_model.Information"/>
                </MudCardContent>
            </MudCard>

            <MudCard Elevation="2" Class="mt-3 mb-3">
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Новый диагноз</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Row="true" Spacing="3" Justify="Justify.FlexStart" Class="d-flex flex-wrap">
                        <MudTextField T="string" Variant="Variant.Outlined" Label="Наименование"/>
                        <MudSelect T="string" Variant="Variant.Outlined" Label="Результат">
                            <MudSelectItem T="string"></MudSelectItem>
                        </MudSelect>
                    </MudStack>
                    <MudTextField T="string" Label="Описание" Lines="3" FullWidth="true" Variant="Variant.Outlined" Class="mt-3"/>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Secondary" Class="mt-3">Добавить диагноз</MudButton>
                </MudCardActions>
            </MudCard>

            <MudDataGrid Striped="true" T="Diagnosis" Items="_diagnoses"  SortMode="SortMode.Multiple" Filterable="true" QuickFilter="@QuickFilter">
                <ToolBarContent>
                    <MudText Typo="Typo.h6">Диагнозы</MudText>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" Placeholder="Поиск" Adornment="Adornment.Start" Immediate="true"
                        AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                </ToolBarContent>
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Наименование"/>
                    <PropertyColumn Property="x => x.Description" Title="Описание"/>
                    <PropertyColumn Property="x => x.Date" Title="Дата" Filterable="false"/>
                    <PropertyColumn Property="x => x.Result" Title="Результат" Filterable="false"/>
                </Columns>
            </MudDataGrid>
        </MudTabPanel>
        <MudTabPanel Text="Рекомендации" Icon="@Icons.Material.Filled.Recommend"></MudTabPanel>
        <MudTabPanel Text="Услуги" Icon="@Icons.Material.Filled.Workspaces"></MudTabPanel>
    </MudTabs>
    <MudCardActions>
        <MudButton OnClick="@Close" Style="position: fixed;
                                                   right: 30px; bottom: 30px;
                                                   padding: 10px;" Variant="Variant.Filled" Color="Color.Error">Close</MudButton>
    </MudCardActions>
</MudCard>

@code {

    [Parameter]
    public EventCallback<Models.Appointment.AppointmentTable> AppointmentSelect { get; set; }

    [Parameter]
    public Models.Appointment.AppointmentTable AppointmentTable { get; set; } = null!;

    private Models.Appointment.Appointment? _model;
    private List<Diagnosis> _diagnoses = null!;
    private string? _searchString;

    protected override async Task OnInitializedAsync()
    {
        var appointment = await AppointmentService.GetAppointment(1);
        if (appointment is null)
        {
            _model = new();
            return;
        }
        _model = appointment;

        _diagnoses = await AppointmentService.GetAppointmentDiagnoses(1) ?? new List<Diagnosis>();
        await base.OnInitializedAsync();
    }

    private void Close()
    {
        AppointmentSelect.InvokeAsync(null);
    }
    
    private Func<Diagnosis, bool> QuickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

}